<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Microgrid Management Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/moment@2.29.4/moment.min.js"></script>
    <style>
        :root {
            --primary: #0f172a;
            --secondary: #3b82f6;
            --accent: #8b5cf6;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --info: #06b6d4;
            --surface: #ffffff;
            --surface-dark: #1e293b;
            --surface-secondary: #f8fafc;
            --surface-tertiary: #f1f5f9;
            --text-primary: #0f172a;
            --text-secondary: #64748b;
            --text-tertiary: #94a3b8;
            --border: #e2e8f0;
            --shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1), 0 1px 2px -1px rgb(0 0 0 / 0.1);
            --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
            --shadow-xl: 0 20px 25px -5px rgb(0 0 0 / 0.1), 0 10px 10px -5px rgb(0 0 0 / 0.04);
            --radius: 12px;
            --radius-lg: 16px;
            --gradient-primary: linear-gradient(135deg, var(--secondary) 0%, var(--accent) 100%);
            --gradient-surface: linear-gradient(135deg, var(--surface-secondary) 0%, #e0e7ff 100%);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: var(--gradient-surface);
            color: var(--text-primary);
            line-height: 1.6;
            min-height: 100vh;
        }

        .dashboard {
            max-width: 100%;
            margin: 0;
            padding: 20px;
            display: grid;
            gap: 20px;
            grid-template-columns: 1fr;
        }

        /* Header */
        .header {
            background: var(--surface);
            border-radius: var(--radius-lg);
            padding: 24px;
            box-shadow: var(--shadow-lg);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 16px;
            position: relative;
            overflow: hidden;
        }

        .header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: var(--gradient-primary);
        }

        .header h1 {
            font-size: 2.25rem;
            font-weight: 900;
            background: var(--gradient-primary);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .header-controls {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
            align-items: center;
        }

        /* Navigation Tabs */
        .nav-tabs {
            display: flex;
            gap: 8px;
            padding: 6px;
            background: var(--surface-tertiary);
            border-radius: var(--radius);
        }

        .nav-tab {
            padding: 10px 20px;
            border: none;
            border-radius: calc(var(--radius) - 2px);
            cursor: pointer;
            font-weight: 600;
            font-size: 0.875rem;
            transition: all 0.2s ease;
            background: transparent;
            color: var(--text-secondary);
        }

        .nav-tab.active {
            background: var(--surface);
            color: var(--secondary);
            box-shadow: var(--shadow);
        }

        .nav-tab:hover:not(.active) {
            background: var(--surface-secondary);
            color: var(--text-primary);
        }

        /* Buttons */
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: var(--radius);
            cursor: pointer;
            font-weight: 600;
            font-size: 0.875rem;
            transition: all 0.2s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            box-shadow: var(--shadow);
            text-decoration: none;
        }

        .btn:hover {
            transform: translateY(-1px);
            box-shadow: var(--shadow-lg);
        }

        .btn-primary { background: var(--secondary); color: white; }
        .btn-success { background: var(--success); color: white; }
        .btn-warning { background: var(--warning); color: white; }
        .btn-danger { background: var(--danger); color: white; }
        .btn-info { background: var(--info); color: white; }

        .btn:disabled {
            background: var(--text-tertiary);
            cursor: not-allowed;
            transform: none;
            opacity: 0.6;
        }

        /* Status indicators */
        .status-indicator {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 6px 12px;
            border-radius: var(--radius);
            font-size: 0.875rem;
            font-weight: 600;
            background: var(--surface-secondary);
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .status-active { background: var(--success); }
        .status-paused { background: var(--warning); }
        .status-offline { background: var(--text-tertiary); }

        /* Tab Content */
        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* Environment Tab */
        .environment-section {
            display: grid;
            gap: 20px;
        }

        .environment-controls {
            display: grid;
            grid-template-columns: 1fr auto;
            gap: 20px;
            align-items: start;
        }

        .auto-controls {
            background: var(--surface);
            border-radius: var(--radius-lg);
            padding: 24px;
            box-shadow: var(--shadow);
            min-width: 320px;
        }

        .auto-controls h3 {
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 16px;
        }

        .input-group {
            margin-bottom: 16px;
        }

        .input-group label {
            display: block;
            font-size: 0.875rem;
            font-weight: 600;
            color: var(--text-secondary);
            margin-bottom: 6px;
        }

        .input-group input {
            width: 100%;
            padding: 10px 12px;
            border: 2px solid var(--border);
            border-radius: var(--radius);
            font-size: 0.875rem;
            transition: all 0.2s ease;
        }

        .input-group input:focus {
            outline: none;
            border-color: var(--secondary);
            box-shadow: 0 0 0 3px rgb(59 130 246 / 0.1);
        }

        /* Metrics Grid */
        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .metric-card {
            background: var(--surface);
            border-radius: var(--radius-lg);
            padding: 24px;
            box-shadow: var(--shadow);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .metric-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: var(--gradient-primary);
        }

        .metric-card:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-xl);
        }

        .metric-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .metric-title {
            font-size: 0.875rem;
            font-weight: 700;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .metric-value {
            font-size: 2.5rem;
            font-weight: 900;
            line-height: 1;
            margin-bottom: 8px;
            background: var(--gradient-primary);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .metric-unit {
            font-size: 1rem;
            color: var(--text-tertiary);
            font-weight: 500;
        }

        .metric-trend {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            font-size: 0.875rem;
            font-weight: 600;
            padding: 4px 8px;
            border-radius: 6px;
        }

        .trend-up { background: rgb(16 185 129 / 0.1); color: var(--success); }
        .trend-down { background: rgb(239 68 68 / 0.1); color: var(--danger); }
        .trend-neutral { background: var(--surface-secondary); color: var(--text-tertiary); }

        /* Charts and Controls Grid */
        .main-content {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 20px;
        }

        .charts-section {
            display: grid;
            gap: 20px;
        }

        .chart-container {
            background: var(--surface);
            border-radius: var(--radius-lg);
            padding: 24px;
            box-shadow: var(--shadow);
            transition: all 0.3s ease;
        }

        .chart-container:hover {
            box-shadow: var(--shadow-lg);
        }

        .chart-title {
            font-size: 1.25rem;
            font-weight: 700;
            margin-bottom: 20px;
            color: var(--primary);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        /* Environment Controls */
        .environment-controls-grid {
            background: var(--surface);
            border-radius: var(--radius-lg);
            padding: 24px;
            box-shadow: var(--shadow);
        }

        .controls-title {
            font-size: 1.25rem;
            font-weight: 700;
            margin-bottom: 20px;
            color: var(--primary);
        }

        .control-grid {
            display: grid;
            gap: 20px;
        }

        .control-item {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .control-label {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: 600;
            font-size: 0.875rem;
        }

        .control-value {
            color: var(--secondary);
            font-weight: 700;
        }

        .slider-container {
            display: flex;
            gap: 12px;
            align-items: center;
        }

        .slider {
            flex: 1;
            height: 6px;
            border-radius: 3px;
            background: var(--surface-tertiary);
            outline: none;
            -webkit-appearance: none;
        }

        .slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: var(--secondary);
            cursor: pointer;
            box-shadow: var(--shadow);
            transition: all 0.2s ease;
        }

        .slider::-webkit-slider-thumb:hover {
            transform: scale(1.1);
            box-shadow: var(--shadow-lg);
        }

        .slider-value {
            width: 80px;
            padding: 8px 12px;
            border: 2px solid var(--border);
            border-radius: var(--radius);
            font-size: 0.875rem;
            text-align: center;
        }

        /* Power Generation Tab */
        .power-section {
            display: grid;
            gap: 20px;
        }

        .device-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
        }

        .device-card {
            background: var(--surface);
            border-radius: var(--radius-lg);
            padding: 20px;
            box-shadow: var(--shadow);
            transition: all 0.3s ease;
        }

        .device-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        .device-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .device-name {
            font-size: 1.1rem;
            font-weight: 700;
            color: var(--primary);
        }

        .device-type {
            font-size: 0.75rem;
            font-weight: 600;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            padding: 4px 8px;
            background: var(--surface-secondary);
            border-radius: 4px;
        }

        .device-power {
            font-size: 1.5rem;
            font-weight: 800;
            color: var(--secondary);
            margin-bottom: 8px;
        }

        .device-details {
            font-size: 0.875rem;
            color: var(--text-secondary);
        }

        /* Add Device Modal */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(4px);
        }

        .modal.show {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: var(--surface);
            border-radius: var(--radius-lg);
            padding: 30px;
            width: 90%;
            max-width: 500px;
            box-shadow: var(--shadow-xl);
            animation: modalSlideIn 0.3s ease;
        }

        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: translateY(-50px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--primary);
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--text-secondary);
            padding: 4px;
        }

        .form-group {
            margin-bottom: 16px;
        }

        .form-group label {
            display: block;
            margin-bottom: 6px;
            font-weight: 600;
            color: var(--text-secondary);
        }

        .form-group input,
        .form-group select {
            width: 100%;
            padding: 10px 12px;
            border: 2px solid var(--border);
            border-radius: var(--radius);
            font-size: 0.875rem;
            transition: all 0.2s ease;
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: var(--secondary);
            box-shadow: 0 0 0 3px rgb(59 130 246 / 0.1);
        }

        /* History Section */
        .history-section {
            background: var(--surface);
            border-radius: var(--radius-lg);
            padding: 24px;
            box-shadow: var(--shadow);
            max-height: 500px;
            display: flex;
            flex-direction: column;
        }

        .history-title {
            font-size: 1.25rem;
            font-weight: 700;
            margin-bottom: 16px;
            color: var(--primary);
        }

        .history-container {
            flex: 1;
            overflow-y: auto;
        }

        .history-table {
            width: 100%;
            border-collapse: collapse;
        }

        .history-table th,
        .history-table td {
            padding: 12px 8px;
            text-align: left;
            border-bottom: 1px solid var(--border);
            font-size: 0.875rem;
        }

        .history-table th {
            background: var(--surface-secondary);
            font-weight: 700;
            color: var(--text-secondary);
            position: sticky;
            top: 0;
            z-index: 1;
        }

        .history-table tr:hover {
            background: var(--surface-secondary);
        }

        /* Notification */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 16px 20px;
            border-radius: var(--radius);
            color: white;
            font-weight: 600;
            z-index: 2000;
            box-shadow: var(--shadow-xl);
            backdrop-filter: blur(10px);
            max-width: 400px;
        }

        .notification-success { background: var(--success); }
        .notification-error { background: var(--danger); }
        .notification-warning { background: var(--warning); }
        .notification-info { background: var(--info); }

        /* Responsive Design */
        @media (max-width: 1200px) {
            .main-content {
                grid-template-columns: 1fr;
            }
            
            .environment-controls {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 768px) {
            .dashboard {
                padding: 16px;
                gap: 16px;
            }
            
            .header {
                flex-direction: column;
                text-align: center;
            }
            
            .header h1 {
                font-size: 1.75rem;
            }
            
            .metrics-grid {
                grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            }
            
            .device-grid {
                grid-template-columns: 1fr;
            }
            
            .nav-tabs {
                flex-direction: column;
                width: 100%;
            }
        }

        /* Loading States */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid var(--surface-tertiary);
            border-radius: 50%;
            border-top-color: var(--secondary);
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Utility Classes */
        .text-center { text-align: center; }
        .mb-4 { margin-bottom: 16px; }
        .mt-4 { margin-top: 16px; }
        .hidden { display: none; }
        .flex { display: flex; }
        .items-center { align-items: center; }
        .justify-between { justify-content: space-between; }
        .gap-2 { gap: 8px; }
        .gap-4 { gap: 16px; }
    </style>
</head>
<body>
    <div class="dashboard">
        <!-- Header -->
        <div class="header">
            <h1>‚ö° Microgrid Control Center</h1>
            <div class="header-controls">
                <div class="nav-tabs">
                    <button class="nav-tab active" data-tab="environment">üåç Environment</button>
                    <button class="nav-tab" data-tab="power">‚ö° Power Systems</button>
                    <button class="nav-tab" data-tab="simulation">üéØ Simulation</button>
                </div>
                <div class="status-indicator" id="systemStatus">
                    <span class="status-dot status-active"></span>
                    System Online
                </div>
            </div>
        </div>

        <!-- Environment Tab -->
        <div id="environment-tab" class="tab-content active">
            <div class="environment-section">
                <div class="environment-controls">
                    <div class="metrics-grid">
                        <div class="metric-card">
                            <div class="metric-header">
                                <div class="metric-title">Current Time</div>
                            </div>
                            <div class="metric-value" id="currentTime">Loading...</div>
                            <div class="metric-trend" id="timeTrend"></div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-header">
                                <div class="metric-title">Temperature</div>
                            </div>
                            <div class="metric-value" id="temperature">--<span class="metric-unit">¬∞C</span></div>
                            <div class="metric-trend" id="temperatureTrend"></div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-header">
                                <div class="metric-title">Solar Radiation</div>
                            </div>
                            <div class="metric-value" id="solarRadiation">--<span class="metric-unit">W/m¬≤</span></div>
                            <div class="metric-trend" id="solarTrend"></div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-header">
                                <div class="metric-title">Cloud Cover</div>
                            </div>
                            <div class="metric-value" id="cloudCover">--<span class="metric-unit">/9</span></div>
                            <div class="metric-trend" id="cloudTrend"></div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-header">
                                <div class="metric-title">Wind Speed</div>
                            </div>
                            <div class="metric-value" id="windSpeed">--<span class="metric-unit">m/s</span></div>
                            <div class="metric-trend" id="windSpeedTrend"></div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-header">
                                <div class="metric-title">Wind Direction</div>
                            </div>
                            <div class="metric-value" id="windDirection">--<span class="metric-unit">¬∞</span></div>
                            <div class="metric-trend" id="windDirectionTrend"></div>
                        </div>
                    </div>

                    <div class="auto-controls">
                        <h3>‚è±Ô∏è Simulation Controls</h3>
                        <div class="input-group">
                            <label for="timestep">Timestep (hours)</label>
                            <input type="number" id="timestep" min="0.1" max="24" step="0.1" value="1.0">
                        </div>
                        <div class="input-group">
                            <label for="interval">Auto Interval (seconds)</label>
                            <input type="number" id="interval" min="1" max="60" value="5">
                        </div>
                        <div class="input-group">
                            <button id="stepBtn" class="btn btn-primary">‚è≠Ô∏è Step Forward</button>
                        </div>
                        <div class="input-group">
                            <button id="autoStepBtn" class="btn btn-success">‚ñ∂Ô∏è Start Auto-Step</button>
                        </div>
                        <div class="input-group">
                            <button id="resetBtn" class="btn btn-warning">üîÑ Reset Environment</button>
                        </div>
                        <div class="status-indicator" id="autoStepStatus">
                            <span class="status-dot status-paused"></span>
                            Auto-step: Paused
                        </div>
                    </div>
                </div>

                <div class="main-content">
                    <div class="charts-section">
                        <div class="chart-container">
                            <div class="chart-title">üå°Ô∏è Temperature & Solar Radiation</div>
                            <canvas id="tempSolarChart"></canvas>
                        </div>
                        <div class="chart-container">
                            <div class="chart-title">üí® Wind Conditions</div>
                            <canvas id="windChart"></canvas>
                        </div>
                        <div class="chart-container">
                            <div class="chart-title">‚òÅÔ∏è Cloud Cover Impact</div>
                            <canvas id="cloudSolarChart"></canvas>
                        </div>
                    </div>

                    <div class="controls-history-section">
                        <div class="environment-controls-grid">
                            <div class="controls-title">üéõÔ∏è Environment Controls</div>
                            <div class="control-grid">
                                <div class="control-item">
                                    <div class="control-label">
                                        <span>Wind Direction</span>
                                        <span class="control-value" id="windDirectionControlValue">180¬∞</span>
                                    </div>
                                    <div class="slider-container">
                                        <input type="range" min="0" max="359" value="180" class="slider" id="windDirectionSlider">
                                        <input type="number" min="0" max="359" value="180" class="slider-value" id="windDirectionInput">
                                    </div>
                                    <button class="btn btn-primary" id="setWindDirectionBtn">Set Wind Direction</button>
                                </div>
                            </div>
                        </div>

                        <div class="history-section">
                            <div class="history-title">üìä Environment History</div>
                            <div class="history-container">
                                <table class="history-table" id="historyTable">
                                    <thead>
                                        <tr>
                                            <th>Time</th>
                                            <th>Temp (¬∞C)</th>
                                            <th>Solar (W/m¬≤)</th>
                                            <th>Cloud (/9)</th>
                                            <th>Wind (m/s)</th>
                                            <th>Dir (¬∞)</th>
                                        </tr>
                                    </thead>
                                    <tbody id="historyBody">
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Power Systems Tab -->
        <div id="power-tab" class="tab-content">
            <div class="power-section">
                <div class="flex items-center justify-between mb-4">
                    <h2 style="font-size: 1.5rem; font-weight: 700; color: var(--primary);">‚ö° Power Generation & Storage</h2>
                    <button class="btn btn-success" id="addDeviceBtn">+ Add Device</button>
                </div>

                <div class="metrics-grid mb-4">
                    <div class="metric-card">
                        <div class="metric-header">
                            <div class="metric-title">Total Generation</div>
                        </div>
                        <div class="metric-value" id="totalGeneration">--<span class="metric-unit">kW</span></div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-header">
                            <div class="metric-title">Battery Storage</div>
                        </div>
                        <div class="metric-value" id="batteryStorage">--<span class="metric-unit">kWh</span></div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-header">
                            <div class="metric-title">Grid Flow</div>
                        </div>
                        <div class="metric-value" id="gridFlow">--<span class="metric-unit">kW</span></div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-header">
                            <div class="metric-title">Active Devices</div>
                        </div>
                        <div class="metric-value" id="activeDevices">--<span class="metric-unit">units</span></div>
                    </div>
                </div>

                <div class="device-grid" id="deviceGrid">
                    <!-- Devices will be populated by JavaScript -->
                </div>
            </div>
        </div>

        <!-- Simulation Tab -->
        <div id="simulation-tab" class="tab-content">
            <div class="power-section">
                <h2 style="font-size: 1.5rem; font-weight: 700; color: var(--primary); margin-bottom: 20px;">üéØ Microgrid Simulation</h2>
                
                <div class="main-content">
                    <div class="charts-section">
                        <div class="chart-container">
                            <div class="chart-title">‚ö° Power Generation Mix</div>
                            <canvas id="powerMixChart"></canvas>
                        </div>
                        <div class="chart-container">
                            <div class="chart-title">üîã Battery Performance</div>
                            <canvas id="batteryChart"></canvas>
                        </div>
                    </div>

                    <div class="controls-history-section">
                        <div class="environment-controls-grid">
                            <div class="controls-title">üéÆ Simulation Controls</div>
                            <div class="control-grid">
                                <div class="control-item">
                                    <div class="control-label">
                                        <span>Demand (kW)</span>
                                        <span class="control-value" id="demandControlValue">50 kW</span>
                                    </div>
                                    <div class="slider-container">
                                        <input type="range" min="0" max="200" value="50" class="slider" id="demandSlider">
                                        <input type="number" min="0" max="200" value="50" class="slider-value" id="demandInput">
                                    </div>
                                    <button class="btn btn-primary" id="runSimulationBtn">Run Simulation Step</button>
                                </div>
                                <div class="control-item">
                                    <div class="control-label">
                                        <span>Daily Energy Target</span>
                                        <span class="control-value" id="dailyEnergyValue">150 kWh</span>
                                    </div>
                                    <div class="slider-container">
                                        <input type="range" min="10" max="500" value="150" class="slider" id="dailyEnergySlider">
                                        <input type="number" min="10" max="500" value="150" class="slider-value" id="dailyEnergyInput">
                                    </div>
                                    <button class="btn btn-success" id="realisticSimBtn">Run Realistic Simulation</button>
                                </div>
                                <div class="control-item">
                                    <label>Diesel Strategy:</label>
                                    <select id="dieselStrategy" style="width: 100%; padding: 8px; border: 2px solid var(--border); border-radius: var(--radius);">
                                        <option value="demand_following">Demand Following</option>
                                        <option value="battery_charging">Battery Charging</option>
                                        <option value="manual">Manual Control</option>
                                    </select>
                                    <button class="btn btn-info" id="setStrategyBtn">Set Strategy</button>
                                </div>
                            </div>
                        </div>

                        <div class="history-section">
                            <div class="history-title">üìà Simulation Results</div>
                            <div class="history-container">
                                <table class="history-table" id="simulationResultsTable">
                                    <thead>
                                        <tr>
                                            <th>Time</th>
                                            <th>Demand</th>
                                            <th>Renewable</th>
                                            <th>Battery</th>
                                            <th>Grid</th>
                                            <th>Cost</th>
                                        </tr>
                                    </thead>
                                    <tbody id="simulationResultsBody">
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Device Modal -->
    <div id="addDeviceModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Add New Device</h3>
                <button class="close-btn" id="closeModalBtn">&times;</button>
            </div>
            <form id="deviceForm">
                <div class="form-group">
                    <label for="deviceType">Device Type</label>
                    <select id="deviceType" required>
                        <option value="">Select device type...</option>
                        <option value="windturbine">Wind Turbine</option>
                        <option value="solarpanel">Solar Panel</option>
                        <option value="battery">Battery</option>
                        <option value="dieselgenerator">Diesel Generator</option>
                        <option value="gridconnection">Grid Connection</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="deviceName">Device Name</label>
                    <input type="text" id="deviceName" required placeholder="Enter device name">
                </div>
                <div id="dynamicFields">
                    <!-- Dynamic fields will be populated based on device type -->
                </div>
                <div class="flex gap-2 mt-4">
                    <button type="submit" class="btn btn-primary">Add Device</button>
                    <button type="button" class="btn btn-danger" id="cancelModalBtn">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // Global variables
        const API_BASE_POWER = 'http://localhost:8000';
        
        let environmentData = [];
        let simulationResults = [];
        let autoStepInterval = null;
        let charts = {};
        let previousEnvironmentState = null;
        let currentDevices = [];

        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', function() {
            initializeCharts();
            loadEnvironmentData();
            loadPowerSystemData();
            setupEventListeners();
            setupControlSliders();
            setupTabNavigation();
        });

        // Tab Navigation
        function setupTabNavigation() {
            const tabButtons = document.querySelectorAll('.nav-tab');
            const tabContents = document.querySelectorAll('.tab-content');

            tabButtons.forEach(button => {
                button.addEventListener('click', () => {
                    const targetTab = button.getAttribute('data-tab');
                    
                    // Remove active class from all tabs and contents
                    tabButtons.forEach(btn => btn.classList.remove('active'));
                    tabContents.forEach(content => content.classList.remove('active'));
                    
                    // Add active class to clicked tab and corresponding content
                    button.classList.add('active');
                    document.getElementById(targetTab + '-tab').classList.add('active');
                });
            });
        }

        // Initialize all charts
        function initializeCharts() {
            // Environment charts
            initEnvironmentCharts();
            
            // Power system charts
            initPowerSystemCharts();
        }

        function initEnvironmentCharts() {
            // Temperature & Solar chart
            const tempSolarCtx = document.getElementById('tempSolarChart').getContext('2d');
            charts.tempSolar = new Chart(tempSolarCtx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [
                        {
                            label: 'Temperature (¬∞C)',
                            data: [],
                            borderColor: '#ef4444',
                            backgroundColor: 'rgba(239, 68, 68, 0.1)',
                            yAxisID: 'y',
                            tension: 0.4,
                            fill: true
                        },
                        {
                            label: 'Solar Radiation (W/m¬≤)',
                            data: [],
                            borderColor: '#f59e0b',
                            backgroundColor: 'rgba(245, 158, 11, 0.1)',
                            yAxisID: 'y1',
                            tension: 0.4,
                            fill: true
                        }
                    ]
                },
                options: {
                    responsive: true,
                    interaction: {
                        mode: 'index',
                        intersect: false,
                    },
                    scales: {
                        x: {
                            title: { display: true, text: 'Time' }
                        },
                        y: {
                            type: 'linear',
                            display: true,
                            position: 'left',
                            title: { display: true, text: 'Temperature (¬∞C)' }
                        },
                        y1: {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            title: { display: true, text: 'Solar Radiation (W/m¬≤)' },
                            grid: { drawOnChartArea: false }
                        }
                    }
                }
            });

            // Wind chart
            const windCtx = document.getElementById('windChart').getContext('2d');
            charts.wind = new Chart(windCtx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [
                        {
                            label: 'Wind Speed (m/s)',
                            data: [],
                            borderColor: '#3b82f6',
                            backgroundColor: 'rgba(59, 130, 246, 0.1)',
                            yAxisID: 'y',
                            tension: 0.4,
                            fill: true
                        },
                        {
                            label: 'Wind Direction (¬∞)',
                            data: [],
                            borderColor: '#8b5cf6',
                            backgroundColor: 'rgba(139, 92, 246, 0.1)',
                            yAxisID: 'y1',
                            tension: 0.4
                        }
                    ]
                },
                options: {
                    responsive: true,
                    scales: {
                        x: { title: { display: true, text: 'Time' } },
                        y: {
                            display: true,
                            position: 'left',
                            title: { display: true, text: 'Wind Speed (m/s)' }
                        },
                        y1: {
                            display: true,
                            position: 'right',
                            title: { display: true, text: 'Wind Direction (¬∞)' },
                            grid: { drawOnChartArea: false },
                            min: 0,
                            max: 360
                        }
                    }
                }
            });

            // Cloud & Solar chart
            const cloudSolarCtx = document.getElementById('cloudSolarChart').getContext('2d');
            charts.cloudSolar = new Chart(cloudSolarCtx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [
                        {
                            label: 'Cloud Cover (/9)',
                            data: [],
                            borderColor: '#64748b',
                            backgroundColor: 'rgba(100, 116, 139, 0.1)',
                            yAxisID: 'y',
                            tension: 0.4,
                            fill: true
                        },
                        {
                            label: 'Solar Radiation (W/m¬≤)',
                            data: [],
                            borderColor: '#f59e0b',
                            backgroundColor: 'rgba(245, 158, 11, 0.1)',
                            yAxisID: 'y1',
                            tension: 0.4,
                            fill: true
                        }
                    ]
                },
                options: {
                    responsive: true,
                    scales: {
                        x: { title: { display: true, text: 'Time' } },
                        y: {
                            display: true,
                            position: 'left',
                            title: { display: true, text: 'Cloud Cover (/9)' },
                            reverse: true,
                            min: 0,
                            max: 9
                        },
                        y1: {
                            display: true,
                            position: 'right',
                            title: { display: true, text: 'Solar Radiation (W/m¬≤)' },
                            grid: { drawOnChartArea: false },
                            min: 0
                        }
                    }
                }
            });
        }

        function initPowerSystemCharts() {
            // Power Mix chart
            const powerMixCtx = document.getElementById('powerMixChart').getContext('2d');
            charts.powerMix = new Chart(powerMixCtx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [
                        {
                            label: 'Renewable (kW)',
                            data: [],
                            borderColor: '#10b981',
                            backgroundColor: 'rgba(16, 185, 129, 0.1)',
                            tension: 0.4,
                            fill: true
                        },
                        {
                            label: 'Diesel (kW)',
                            data: [],
                            borderColor: '#f59e0b',
                            backgroundColor: 'rgba(245, 158, 11, 0.1)',
                            tension: 0.4,
                            fill: true
                        },
                        {
                            label: 'Grid (kW)',
                            data: [],
                            borderColor: '#3b82f6',
                            backgroundColor: 'rgba(59, 130, 246, 0.1)',
                            tension: 0.4
                        }
                    ]
                },
                options: {
                    responsive: true,
                    scales: {
                        x: { title: { display: true, text: 'Time' } },
                        y: { title: { display: true, text: 'Power (kW)' } }
                    }
                }
            });

            // Battery chart
            const batteryCtx = document.getElementById('batteryChart').getContext('2d');
            charts.battery = new Chart(batteryCtx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [
                        {
                            label: 'Battery SOC (%)',
                            data: [],
                            borderColor: '#8b5cf6',
                            backgroundColor: 'rgba(139, 92, 246, 0.1)',
                            yAxisID: 'y',
                            tension: 0.4,
                            fill: true
                        },
                        {
                            label: 'Battery Power (kW)',
                            data: [],
                            borderColor: '#06b6d4',
                            backgroundColor: 'rgba(6, 182, 212, 0.1)',
                            yAxisID: 'y1',
                            tension: 0.4
                        }
                    ]
                },
                options: {
                    responsive: true,
                    scales: {
                        x: { title: { display: true, text: 'Time' } },
                        y: {
                            display: true,
                            position: 'left',
                            title: { display: true, text: 'SOC (%)' },
                            min: 0,
                            max: 100
                        },
                        y1: {
                            display: true,
                            position: 'right',
                            title: { display: true, text: 'Power (kW)' },
                            grid: { drawOnChartArea: false }
                        }
                    }
                }
            });
        }

        // Load environment data
        async function loadEnvironmentData() {
            try {
                const response = await fetch(`${API_BASE_ENV}/environment`);
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                const data = await response.json();
                updateEnvironmentDashboard(data);
            } catch (error) {
                console.error('Error loading environment data:', error);
                showNotification('Environment API connection failed. Check if server is running on port 8100.', 'error');
            }
        }

        // Load power system data
        async function loadPowerSystemData() {
            try {
                const response = await fetch(`${API_BASE_POWER}/`);
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                const data = await response.json();
                updatePowerSystemDashboard(data);
            } catch (error) {
                console.error('Error loading power system data:', error);
                showNotification('Power API connection failed. Check if server is running on port 8000.', 'error');
            }
        }

        // Update environment dashboard
        function updateEnvironmentDashboard(data) {
            const currentState = {
                timestamp: new Date(),
                data: data
            };
            
            environmentData.push(currentState);
            if (environmentData.length > 50) {
                environmentData = environmentData.slice(-50);
            }
            
            // Update current values
            document.getElementById('currentTime').textContent = data.time;
            document.getElementById('temperature').textContent = data.temperature;
            document.getElementById('solarRadiation').textContent = data.solar_radiation;
            document.getElementById('cloudCover').textContent = data.cloud_cover.toFixed(1);
            document.getElementById('windSpeed').textContent = data.wind_speed;
            document.getElementById('windDirection').textContent = data.wind_direction;
            
            // Update trends if we have previous state
            if (previousEnvironmentState) {
                updateTrends(currentState, previousEnvironmentState);
            }
            
            updateEnvironmentCharts();
            updateEnvironmentHistory();
            
            previousEnvironmentState = currentState;
        }

        // Update power system dashboard
        function updatePowerSystemDashboard(data) {
            currentDevices = data.devices || [];
            
            // Update summary metrics
            document.getElementById('totalGeneration').textContent = (data.total_generation || 0).toFixed(1);
            document.getElementById('batteryStorage').textContent = data.batteries ? 
                data.batteries.reduce((sum, bat) => sum + bat.state_of_charge, 0).toFixed(1) : '0';
            document.getElementById('gridFlow').textContent = (data.total_grid_power || 0).toFixed(1);
            document.getElementById('activeDevices').textContent = currentDevices.length;
            
            updateDeviceGrid();
        }

        // Update device grid
        function updateDeviceGrid() {
            const deviceGrid = document.getElementById('deviceGrid');
            deviceGrid.innerHTML = '';
            
            if (currentDevices.length === 0) {
                deviceGrid.innerHTML = `
                    <div style="grid-column: 1/-1; text-align: center; padding: 40px; color: var(--text-secondary);">
                        <h3>No devices configured</h3>
                        <p>Click "Add Device" to start building your microgrid</p>
                    </div>
                `;
                return;
            }
            
            currentDevices.forEach(device => {
                const deviceCard = createDeviceCard(device);
                deviceGrid.appendChild(deviceCard);
            });
        }

        function createDeviceCard(device) {
            const card = document.createElement('div');
            card.className = 'device-card';
            
            const statusColor = device.power_output > 0 ? 'var(--success)' : 'var(--text-tertiary)';
            const typeIcon = getDeviceIcon(device.type);
            
            card.innerHTML = `
                <div class="device-header">
                    <div>
                        <div class="device-name">${typeIcon} ${device.name}</div>
                        <div class="device-type">${device.type}</div>
                    </div>
                    <button class="btn btn-danger" onclick="removeDevice('${device.name}')" style="font-size: 0.75rem; padding: 4px 8px;">Remove</button>
                </div>
                <div class="device-power" style="color: ${statusColor};">
                    ${device.power_output.toFixed(1)} kW
                </div>
                <div class="device-details">
                    ${getDeviceDetails(device)}
                </div>
            `;
            
            return card;
        }

        function getDeviceIcon(type) {
            const icons = {
                'WindTurbine': 'üå™Ô∏è',
                'SolarPanel': '‚òÄÔ∏è',
                'Battery': 'üîã',
                'DieselGenerator': '‚õΩ',
                'GridConnection': 'üîå'
            };
            return icons[type] || '‚ö°';
        }

        function getDeviceDetails(device) {
            switch (device.type) {
                case 'WindTurbine':
                    return `Rated: ${device.rated_power}kW | Direction: ${device.direction}¬∞`;
                case 'SolarPanel':
                    return `Rated: ${device.rated_power}kW | Temp Coeff: ${device.temp_coefficient}`;
                case 'Battery':
                    return `Capacity: ${device.capacity_kwh}kWh | SOC: ${device.soc_percent.toFixed(1)}%`;
                case 'DieselGenerator':
                    return `Rated: ${device.rated_power}kW | Usage: ${device.current_diesel_usage.toFixed(2)}L/h`;
                case 'GridConnection':
                    return `Import: ${device.import_price}/kWh | Export: ${device.export_price}/kWh`;
                default:
                    return 'Unknown device type';
            }
        }

        // Environment control functions
        function setupEventListeners() {
            // Environment controls
            document.getElementById('stepBtn').addEventListener('click', stepEnvironment);
            document.getElementById('autoStepBtn').addEventListener('click', toggleAutoStep);
            document.getElementById('resetBtn').addEventListener('click', resetEnvironment);
            
            // Environment setting buttons
            document.getElementById('setTempBtn').addEventListener('click', setTemperature);
            document.getElementById('setSolarBtn').addEventListener('click', setSolarRadiation);
            document.getElementById('setCloudBtn').addEventListener('click', setCloudCover);
            document.getElementById('setWindSpeedBtn').addEventListener('click', setWindSpeed);
            document.getElementById('setWindDirectionBtn').addEventListener('click', setWindDirection);
            
            // Power system controls
            document.getElementById('addDeviceBtn').addEventListener('click', showAddDeviceModal);
            document.getElementById('closeModalBtn').addEventListener('click', hideAddDeviceModal);
            document.getElementById('cancelModalBtn').addEventListener('click', hideAddDeviceModal);
            document.getElementById('deviceForm').addEventListener('submit', addDevice);
            document.getElementById('deviceType').addEventListener('change', updateDynamicFields);
            
            // Simulation controls
            document.getElementById('runSimulationBtn').addEventListener('click', runSimulationStep);
            document.getElementById('realisticSimBtn').addEventListener('click', runRealisticSimulation);
            document.getElementById('setStrategyBtn').addEventListener('click', setDieselStrategy);
        }

        function setupControlSliders() {
            // Environment sliders
            setupSlider('temp', 'Temperature', '¬∞C');
            setupSlider('solar', 'Solar Radiation', ' W/m¬≤');
            setupSlider('cloud', 'Cloud Cover', '/9');
            setupSlider('windSpeed', 'Wind Speed', ' m/s');
            setupSlider('windDirection', 'Wind Direction', '¬∞');
            
            // Simulation sliders
            setupSlider('demand', 'Demand', ' kW', 'demandControlValue');
            setupSlider('dailyEnergy', 'Daily Energy', ' kWh', 'dailyEnergyValue');
        }

        function setupSlider(prefix, label, unit, valueElementId = null) {
            const slider = document.getElementById(prefix + 'Slider');
            const input = document.getElementById(prefix + 'Input');
            const valueElement = document.getElementById(valueElementId || prefix + 'ControlValue');
            
            if (!slider || !input) return;
            
            slider.addEventListener('input', function() {
                input.value = this.value;
                if (valueElement) {
                    valueElement.textContent = `${this.value}${unit}`;
                }
            });
            
            input.addEventListener('input', function() {
                const value = parseFloat(this.value) || 0;
                slider.value = value;
                if (valueElement) {
                    valueElement.textContent = `${value}${unit}`;
                }
            });
        }

        // Environment API functions
        async function stepEnvironment() {
            const timestep = parseFloat(document.getElementById('timestep').value) || 1.0;
            
            try {
                const response = await fetch(`${API_BASE_ENV}/step?timestep_hours=${timestep}`, {
                    method: 'POST'
                });
                
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                
                const data = await response.json();
                updateEnvironmentDashboard(data);
                showNotification(`Environment stepped forward by ${timestep} hours`, 'success');
            } catch (error) {
                console.error('Error stepping environment:', error);
                showNotification('Error stepping environment', 'error');
            }
        }

        function toggleAutoStep() {
            const btn = document.getElementById('autoStepBtn');
            const status = document.getElementById('autoStepStatus');
            
            if (autoStepInterval) {
                clearInterval(autoStepInterval);
                autoStepInterval = null;
                btn.textContent = '‚ñ∂Ô∏è Start Auto-Step';
                btn.className = 'btn btn-success';
                status.innerHTML = '<span class="status-dot status-paused"></span> Auto-step: Paused';
                showNotification('Auto-step stopped', 'info');
            } else {
                const interval = parseInt(document.getElementById('interval').value) * 1000 || 5000;
                autoStepInterval = setInterval(stepEnvironment, interval);
                btn.textContent = '‚è∏Ô∏è Stop Auto-Step';
                btn.className = 'btn btn-danger';
                status.innerHTML = '<span class="status-dot status-active"></span> Auto-step: Running';
                showNotification(`Auto-step started with ${interval/1000}s interval`, 'success');
            }
        }

        async function resetEnvironment() {
            if (!confirm('This will reset the environment to its initial state. Continue?')) return;
            
            try {
                const response = await fetch(`${API_BASE_ENV}/reset`, { method: 'POST' });
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                
                const result = await response.json();
                environmentData = [];
                previousEnvironmentState = null;
                updateEnvironmentDashboard(result.environment);
                showNotification('Environment reset successfully', 'success');
            } catch (error) {
                console.error('Error resetting environment:', error);
                showNotification('Error resetting environment', 'error');
            }
        }

        async function setTemperature() {
            const value = parseFloat(document.getElementById('tempInput').value);
            if (isNaN(value) || value < -50 || value > 50) {
                showNotification('Please enter a valid temperature between -50 and 50¬∞C', 'warning');
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE_ENV}/environment/temperature?temperature=${value}`, {
                    method: 'POST'
                });
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                
                const result = await response.json();
                showNotification(result.message, 'success');
                loadEnvironmentData();
            } catch (error) {
                console.error('Error setting temperature:', error);
                showNotification('Error setting temperature', 'error');
            }
        }

        async function setSolarRadiation() {
            const value = parseFloat(document.getElementById('solarInput').value);
            if (isNaN(value) || value < 0 || value > 1000) {
                showNotification('Please enter a valid solar radiation value between 0 and 1000 W/m¬≤', 'warning');
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE_ENV}/environment/solar_radiation?solar_radiation=${value}`, {
                    method: 'POST'
                });
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                
                const result = await response.json();
                showNotification(result.message, 'success');
                loadEnvironmentData();
            } catch (error) {
                console.error('Error setting solar radiation:', error);
                showNotification('Error setting solar radiation', 'error');
            }
        }

        async function setCloudCover() {
            const value = parseFloat(document.getElementById('cloudInput').value);
            if (isNaN(value) || value < 0 || value > 9) {
                showNotification('Please enter a valid cloud cover value between 0 and 9', 'warning');
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE_ENV}/environment/cloud_cover?cloud_cover=${value}`, {
                    method: 'POST'
                });
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                
                const result = await response.json();
                showNotification(result.message, 'success');
                loadEnvironmentData();
            } catch (error) {
                console.error('Error setting cloud cover:', error);
                showNotification('Error setting cloud cover', 'error');
            }
        }

        async function setWindSpeed() {
            const value = parseFloat(document.getElementById('windSpeedInput').value);
            if (isNaN(value) || value < 0 || value > 100) {
                showNotification('Please enter a valid wind speed between 0 and 100 m/s', 'warning');
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE_ENV}/environment/wind_speed?wind_speed=${value}`, {
                    method: 'POST'
                });
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                
                const result = await response.json();
                showNotification(result.message, 'success');
                loadEnvironmentData();
            } catch (error) {
                console.error('Error setting wind speed:', error);
                showNotification('Error setting wind speed', 'error');
            }
        }

        async function setWindDirection() {
            const value = parseFloat(document.getElementById('windDirectionInput').value);
            if (isNaN(value) || value < 0 || value >= 360) {
                showNotification('Please enter a valid wind direction between 0 and 359 degrees', 'warning');
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE_ENV}/environment/wind_direction?wind_direction=${value}`, {
                    method: 'POST'
                });
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                
                const result = await response.json();
                showNotification(result.message, 'success');
                loadEnvironmentData();
            } catch (error) {
                console.error('Error setting wind direction:', error);
                showNotification('Error setting wind direction', 'error');
            }
        }

        // Power system functions
        function showAddDeviceModal() {
            document.getElementById('addDeviceModal').classList.add('show');
        }

        function hideAddDeviceModal() {
            document.getElementById('addDeviceModal').classList.remove('show');
            document.getElementById('deviceForm').reset();
            document.getElementById('dynamicFields').innerHTML = '';
        }

        function updateDynamicFields() {
            const deviceType = document.getElementById('deviceType').value;
            const dynamicFields = document.getElementById('dynamicFields');
            
            let fieldsHTML = '';
            
            switch (deviceType) {
                case 'windturbine':
                    fieldsHTML = `
                        <div class="form-group">
                            <label>Rated Power (kW)</label>
                            <input type="number" name="rated_power" min="0" step="0.1" required>
                        </div>
                        <div class="form-group">
                            <label>Direction (degrees)</label>
                            <input type="number" name="direction" min="0" max="360" required>
                        </div>
                        <div class="form-group">
                            <label>Cut-in Speed (m/s)</label>
                            <input type="number" name="cut_in_speed" min="0" step="0.1" value="3.0">
                        </div>
                        <div class="form-group">
                            <label>Rated Speed (m/s)</label>
                            <input type="number" name="rated_speed" min="0" step="0.1" value="12.0">
                        </div>
                        <div class="form-group">
                            <label>Cut-out Speed (m/s)</label>
                            <input type="number" name="cut_out_speed" min="0" step="0.1" value="25.0">
                        </div>
                    `;
                    break;
                case 'solarpanel':
                    fieldsHTML = `
                        <div class="form-group">
                            <label>Rated Power (kW)</label>
                            <input type="number" name="rated_power" min="0" step="0.1" required>
                        </div>
                        <div class="form-group">
                            <label>Temperature Coefficient</label>
                            <input type="number" name="temp_coefficient" min="0" step="0.001" value="0.004">
                        </div>
                        <div class="form-group">
                            <label>STC Temperature (¬∞C)</label>
                            <input type="number" name="stc_temp" value="25.0">
                        </div>
                    `;
                    break;
                case 'battery':
                    fieldsHTML = `
                        <div class="form-group">
                            <label>Capacity (kWh)</label>
                            <input type="number" name="capacity_kwh" min="0" step="0.1" required>
                        </div>
                        <div class="form-group">
                            <label>Max Power (kW)</label>
                            <input type="number" name="max_power_kw" min="0" step="0.1" required>
                        </div>
                        <div class="form-group">
                            <label>Efficiency (0-1)</label>
                            <input type="number" name="efficiency" min="0" max="1" step="0.01" value="0.90">
                        </div>
                        <div class="form-group">
                            <label>Initial Charge (0-1)</label>
                            <input type="number" name="initial_charge" min="0" max="1" step="0.01" value="0.5">
                        </div>
                    `;
                    break;
                case 'dieselgenerator':
                    fieldsHTML = `
                        <div class="form-group">
                            <label>Rated Power (kW)</label>
                            <input type="number" name="rated_power" min="0" step="0.1" required>
                        </div>
                        <div class="form-group">
                            <label>Diesel Usage (L/kW)</label>
                            <input type="number" name="diesel_usage_litre_per_kw" min="0" step="0.01" value="0.4">
                        </div>
                    `;
                    break;
                case 'gridconnection':
                    fieldsHTML = `
                        <div class="form-group">
                            <label>Import Price ($/kWh)</label>
                            <input type="number" name="import_price" min="0" step="0.01" required>
                        </div>
                        <div class="form-group">
                            <label>Export Price ($/kWh)</label>
                            <input type="number" name="export_price" min="0" step="0.01" required>
                        </div>
                    `;
                    break;
            }
            
            dynamicFields.innerHTML = fieldsHTML;
        }

        async function addDevice(event) {
            event.preventDefault();
            
            const formData = new FormData(event.target);
            const deviceType = document.getElementById('deviceType').value;
            const deviceName = document.getElementById('deviceName').value;
            
            const deviceData = {
                name: deviceName
            };
            
            // Add device-specific fields
            for (let [key, value] of formData.entries()) {
                if (key !== 'deviceType' && key !== 'deviceName') {
                    deviceData[key] = isNaN(value) ? value : parseFloat(value);
                }
            }
            
            try {
                const response = await fetch(`${API_BASE_POWER}/add/${deviceType}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(deviceData)
                });
                
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.detail || 'Failed to add device');
                }
                
                const result = await response.json();
                showNotification(result.message, 'success');
                hideAddDeviceModal();
                loadPowerSystemData();
            } catch (error) {
                console.error('Error adding device:', error);
                showNotification(error.message, 'error');
            }
        }

        async function removeDevice(deviceName) {
            if (!confirm(`Are you sure you want to remove device "${deviceName}"?`)) return;
            
            try {
                const response = await fetch(`${API_BASE_POWER}/remove/${deviceName}`, {
                    method: 'DELETE'
                });
                
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                
                const result = await response.json();
                showNotification(result.message, 'success');
                loadPowerSystemData();
            } catch (error) {
                console.error('Error removing device:', error);
                showNotification('Error removing device', 'error');
            }
        }

        // Simulation functions
        async function runSimulationStep() {
            const demand = parseFloat(document.getElementById('demandInput').value) || 50;
            const timestep = parseFloat(document.getElementById('timestep').value) || 1.0;
            
            try {
                const response = await fetch(`${API_BASE_POWER}/simulate/step`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        demand_kw: demand,
                        timestep_hours: timestep
                    })
                });
                
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                
                const result = await response.json();
                addSimulationResult(result.simulation_results);
                showNotification('Simulation step completed', 'success');
                loadPowerSystemData();
            } catch (error) {
                console.error('Error running simulation:', error);
                showNotification('Error running simulation', 'error');
            }
        }

        async function runRealisticSimulation() {
            const dailyEnergy = parseFloat(document.getElementById('dailyEnergyInput').value) || 150;
            const timestep = parseFloat(document.getElementById('timestep').value) || 1.0;
            
            try {
                const response = await fetch(`${API_BASE_POWER}/simulate/realistic?total_daily_kwh=${dailyEnergy}&timestep_hours=${timestep}`, {
                    method: 'POST'
                });
                
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                
                const result = await response.json();
                addSimulationResult(result.simulation_results);
                showNotification(`Realistic simulation completed (${result.calculated_demand.toFixed(1)} kW demand)`, 'success');
                loadPowerSystemData();
                
                // Also update environment since realistic simulation steps the environment
                updateEnvironmentDashboard(result.environment_state);
            } catch (error) {
                console.error('Error running realistic simulation:', error);
                showNotification('Error running realistic simulation', 'error');
            }
        }

        async function setDieselStrategy() {
            const strategy = document.getElementById('dieselStrategy').value;
            
            try {
                const response = await fetch(`${API_BASE_POWER}/diesel/strategy?strategy=${strategy}`, {
                    method: 'POST'
                });
                
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                
                const result = await response.json();
                showNotification(result.message, 'success');
            } catch (error) {
                console.error('Error setting diesel strategy:', error);
                showNotification('Error setting diesel strategy', 'error');
            }
        }

        function addSimulationResult(result) {
            simulationResults.push(result);
            if (simulationResults.length > 50) {
                simulationResults = simulationResults.slice(-50);
            }
            
            updateSimulationHistory();
            updatePowerCharts();
        }

        function updateSimulationHistory() {
            const tbody = document.getElementById('simulationResultsBody');
            tbody.innerHTML = '';
            
            const recentResults = simulationResults.slice(-10).reverse();
            
            recentResults.forEach(result => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${result.Time}</td>
                    <td>${result['Demand (kW)'].toFixed(1)}</td>
                    <td>${result['Renewable Generation (kW)'].toFixed(1)}</td>
                    <td>${result['Battery Flow (kW)'].toFixed(1)}</td>
                    <td>${result['Grid Flow (kW)'].toFixed(1)}</td>
                    <td>${result['Total Grid Cost ($)'].toFixed(2)}</td>
                `;
                tbody.appendChild(row);
            });
        }

        function updatePowerCharts() {
            if (simulationResults.length === 0) return;
            
            const labels = simulationResults.map(r => r.Time.split(' ')[1] || r.Time);
            
            // Power mix chart
            if (charts.powerMix) {
                charts.powerMix.data.labels = labels;
                charts.powerMix.data.datasets[0].data = simulationResults.map(r => r['Renewable Generation (kW)']);
                charts.powerMix.data.datasets[1].data = simulationResults.map(r => r['Diesel Generation (kW)']);
                charts.powerMix.data.datasets[2].data = simulationResults.map(r => r['Grid Flow (kW)']);
                charts.powerMix.update('none');
            }
            
            // Battery chart
            if (charts.battery) {
                charts.battery.data.labels = labels;
                const socData = simulationResults.map(r => {
                    const totalCapacity = currentDevices
                        .filter(d => d.type === 'Battery')
                        .reduce((sum, bat) => sum + bat.capacity_kwh, 1);
                    return (r['Total Battery SOC (kWh)'] / totalCapacity) * 100;
                });
                charts.battery.data.datasets[0].data = socData;
                charts.battery.data.datasets[1].data = simulationResults.map(r => r['Battery Flow (kW)']);
                charts.battery.update('none');
            }
        }

        // Utility functions
        function updateTrends(current, previous) {
            const timeDiff = current.timestamp - previous.timestamp;
            const minTimeDiff = 15 * 60 * 1000; // 15 minutes
            
            if (timeDiff < minTimeDiff && environmentData.length > 2) {
                const olderState = environmentData[environmentData.length - 3];
                if (olderState) previous = olderState;
            }
            
            setTrendIndicator('temperatureTrend', current.data.temperature - previous.data.temperature, '¬∞C', 0.5);
            setTrendIndicator('solarTrend', current.data.solar_radiation - previous.data.solar_radiation, 'W/m¬≤', 10);
            setTrendIndicator('cloudTrend', -(current.data.cloud_cover - previous.data.cloud_cover), '/9', 0.3);
            setTrendIndicator('windSpeedTrend', current.data.wind_speed - previous.data.wind_speed, 'm/s', 0.5);
            
            const windDirectionDiff = calculateAngularDifference(current.data.wind_direction, previous.data.wind_direction);
            setTrendIndicator('windDirectionTrend', windDirectionDiff, '¬∞', 10);
        }

        function calculateAngularDifference(current, previous) {
            let diff = Math.abs(current - previous);
            if (diff > 180) diff = 360 - diff;
            
            let directDiff = current - previous;
            if (directDiff > 180) directDiff -= 360;
            if (directDiff < -180) directDiff += 360;
            
            return directDiff;
        }

        function setTrendIndicator(elementId, difference, unit, threshold) {
            const element = document.getElementById(elementId);
            if (!element) return;
            
            const absDiff = Math.abs(difference);
            let trendClass, symbol, displayText;
            
            if (difference > threshold) {
                trendClass = 'trend-up';
                symbol = '‚Üó';
                displayText = `${symbol} +${absDiff.toFixed(1)}${unit}`;
            } else if (difference < -threshold) {
                trendClass = 'trend-down';
                symbol = '‚Üò';
                displayText = `${symbol} -${absDiff.toFixed(1)}${unit}`;
            } else {
                trendClass = 'trend-neutral';
                symbol = '‚Üí';
                displayText = `${symbol} Stable`;
            }
            
            element.className = `metric-trend ${trendClass}`;
            element.innerHTML = displayText;
        }

        function updateEnvironmentCharts() {
            const labels = environmentData.map(item => 
                moment(item.timestamp).format('HH:mm')
            );
            
            const temperatures = environmentData.map(item => item.data.temperature);
            const solarRadiation = environmentData.map(item => item.data.solar_radiation);
            const cloudCover = environmentData.map(item => item.data.cloud_cover);
            const windSpeed = environmentData.map(item => item.data.wind_speed);
            const windDirection = environmentData.map(item => item.data.wind_direction);
            
            // Update temperature & solar chart
            if (charts.tempSolar) {
                charts.tempSolar.data.labels = labels;
                charts.tempSolar.data.datasets[0].data = temperatures;
                charts.tempSolar.data.datasets[1].data = solarRadiation;
                charts.tempSolar.update('none');
            }
            
            // Update wind chart
            if (charts.wind) {
                charts.wind.data.labels = labels;
                charts.wind.data.datasets[0].data = windSpeed;
                charts.wind.data.datasets[1].data = windDirection;
                charts.wind.update('none');
            }
            
            // Update cloud & solar chart
            if (charts.cloudSolar) {
                charts.cloudSolar.data.labels = labels;
                charts.cloudSolar.data.datasets[0].data = cloudCover;
                charts.cloudSolar.data.datasets[1].data = solarRadiation;
                charts.cloudSolar.update('none');
            }
        }

        function updateEnvironmentHistory() {
            const tbody = document.getElementById('historyBody');
            tbody.innerHTML = '';
            
            const recentData = environmentData.slice(-10).reverse();
            
            recentData.forEach(item => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${item.data.time}</td>
                    <td>${item.data.temperature.toFixed(1)}</td>
                    <td>${item.data.solar_radiation.toFixed(1)}</td>
                    <td>${item.data.cloud_cover.toFixed(1)}</td>
                    <td>${item.data.wind_speed.toFixed(1)}</td>
                    <td>${item.data.wind_direction.toFixed(1)}</td>
                `;
                tbody.appendChild(row);
            });
        }

        function showNotification(message, type) {
            // Remove existing notification
            const existingNotification = document.querySelector('.notification');
            if (existingNotification) {
                existingNotification.remove();
            }
            
            // Create new notification
            const notification = document.createElement('div');
            notification.className = `notification notification-${type}`;
            notification.textContent = message;
            
            document.body.appendChild(notification);
            
            // Auto-remove after 4 seconds
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.parentNode.removeChild(notification);
                }
            }, 4000);
        }

        // Auto-refresh data every 30 seconds
        setInterval(() => {
            if (!autoStepInterval) { // Only refresh if not auto-stepping
                loadEnvironmentData();
                loadPowerSystemData();
            }
        }, 30000);
    </script>
</body>
</html>
                >Temperature</span>
                                        <span class="control-value" id="tempControlValue">20¬∞C</span>
                                    </div>
                                    <div class="slider-container">
                                        <input type="range" min="-50" max="50" value="20" class="slider" id="tempSlider">
                                        <input type="number" min="-50" max="50" value="20" class="slider-value" id="tempInput">
                                    </div>
                                    <button class="btn btn-primary" id="setTempBtn">Set Temperature</button>
                                </div>
                                <div class="control-item">
                                    <div class="control-label">
                                        <span>Solar Radiation</span>
                                        <span class="control-value" id="solarControlValue">500 W/m¬≤</span>
                                    </div>
                                    <div class="slider-container">
                                        <input type="range" min="0" max="1000" value="500" class="slider" id="solarSlider">
                                        <input type="number" min="0" max="1000" value="500" class="slider-value" id="solarInput">
                                    </div>
                                    <button class="btn btn-primary" id="setSolarBtn">Set Solar Radiation</button>
                                </div>
                                <div class="control-item">
                                    <div class="control-label">
                                        <span>Cloud Cover</span>
                                        <span class="control-value" id="cloudControlValue">4.5/9</span>
                                    </div>
                                    <div class="slider-container">
                                        <input type="range" min="0" max="9" value="4.5" step="0.1" class="slider" id="cloudSlider">
                                        <input type="number" min="0" max="9" step="0.1" value="4.5" class="slider-value" id="cloudInput">
                                    </div>
                                    <button class="btn btn-primary" id="setCloudBtn">Set Cloud Cover</button>
                                </div>
                                <div class="control-item">
                                    <div class="control-label">
                                        <span>Wind Speed</span>
                                        <span class="control-value" id="windSpeedControlValue">5 m/s</span>
                                    </div>
                                    <div class="slider-container">
                                        <input type="range" min="0" max="100" value="5" step="0.1" class="slider" id="windSpeedSlider">
                                        <input type="number" min="0" max="100" step="0.1" value="5" class="slider-value" id="windSpeedInput">
                                    </div>
                                    <button class="btn btn-primary" id="setWindSpeedBtn">Set Wind Speed</button>
                                </div>
                                <div class="control-item">
                                    <div class="control-label">
                                        <span></span>